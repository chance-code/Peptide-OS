// Prisma Schema for Peptide OS
// Local-first SQLite database

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER PROFILE
// ============================================
model UserProfile {
  id        String   @id @default(cuid())
  name      String
  notes     String?
  isActive  Boolean  @default(false) // Currently selected profile
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  protocols          Protocol[]
  inventoryVials     InventoryVial[]
  doseLogs           DoseLog[]
  reconstitutions    Reconstitution[]
  healthIntegrations HealthIntegration[]
  healthMetrics      HealthMetric[]
  labResults         LabResult[]
  labUploads         LabUpload[]
  biologicalLiteracy UserBiologicalLiteracy?
  discoveryInsights  DiscoveryInsight[]
  healthBrainSnapshots HealthBrainSnapshot[]
  personalBaselines    PersonalBaseline[]
  labPriorResets       LabPriorResetEvent[]
  weeklyBriefs         WeeklyHealthBrief[]
  wearableLabCorrelations WearableLabCorrelation[]
}

// ============================================
// PEPTIDE DEFINITIONS
// ============================================
model Peptide {
  id             String   @id @default(cuid())
  name           String   @unique
  canonicalName  String?  // AI-classified canonical name for mechanism lookup
  type           String   @default("peptide")  // 'peptide' | 'supplement'
  category       String?
  description    String?
  storageNotes   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  protocols      Protocol[]
  inventoryVials InventoryVial[]
  reconstitutions Reconstitution[]
}

// ============================================
// PROTOCOLS & CYCLES
// ============================================
model Protocol {
  id          String    @id @default(cuid())
  userId      String
  peptideId   String

  // Schedule
  startDate   DateTime
  endDate     DateTime? // null = indefinite
  frequency   String    // 'daily', 'weekly', 'custom'
  customDays  String?   // JSON array for custom schedules, e.g. ["mon","wed","fri"]

  // Dosing
  doseAmount  Float
  doseUnit    String    // 'mcg', 'mg', 'IU'
  timing      String?   // e.g., 'morning', 'evening', 'before bed' (single timing, legacy)
  timings     String?   // JSON array for multiple times per day, e.g., '["morning", "night"]'

  // Reconstitution info (for cheat sheet - peptides only)
  vialAmount    Float?    // Total peptide in vial (e.g., 10 for 10mg)
  vialUnit      String?   // 'mg', 'mcg', 'IU'
  diluentVolume Float?    // mL of BAC water added

  // Serving info (for supplements)
  servingSize   Int?      // Number of units per dose (e.g., 2 for "2 capsules")
  servingUnit   String?   // 'capsule', 'tablet', 'softgel', 'scoop', 'drop', 'spray'

  // Status
  status      String    @default("active") // 'active', 'paused', 'completed'
  pausedAt    DateTime?

  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user        UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  peptide     Peptide     @relation(fields: [peptideId], references: [id])
  doseLogs    DoseLog[]
  schedules   DoseSchedule[]
  history     ProtocolHistory[]
  labExpectations ProtocolLabExpectation[]

  // Indexes for query performance
  @@index([userId])
  @@index([userId, status])
  @@index([startDate])
  @@index([userId, status, startDate])
}

// ============================================
// DOSE SCHEDULE (Pre-generated daily entries)
// ============================================
model DoseSchedule {
  id          String   @id @default(cuid())
  protocolId  String
  scheduledDate DateTime // The date this dose is scheduled

  doseAmount  Float
  doseUnit    String
  timing      String?

  createdAt   DateTime @default(now())

  // Relations
  protocol    Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  doseLog     DoseLog?

  @@unique([protocolId, scheduledDate])
  @@index([scheduledDate])
}

// ============================================
// DOSE LOG (Actual adherence tracking)
// ============================================
model DoseLog {
  id           String   @id @default(cuid())
  userId       String
  scheduleId   String?  @unique // Links to pre-generated schedule
  protocolId   String

  scheduledDate DateTime
  completedAt   DateTime?
  timing        String?   // Which timing this dose is for (e.g., 'morning', 'night')

  status       String   // 'pending', 'completed', 'skipped', 'missed'
  actualDose   Float?   // If different from scheduled
  actualUnit   String?

  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user        UserProfile   @relation(fields: [userId], references: [id], onDelete: Cascade)
  protocol    Protocol      @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  schedule    DoseSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)

  // Indexes for query performance
  @@index([userId])
  @@index([userId, scheduledDate])
  @@index([protocolId])
  @@index([protocolId, scheduledDate])
}

// ============================================
// INVENTORY VIAL
// ============================================
model InventoryVial {
  id              String    @id @default(cuid())
  userId          String
  peptideId       String

  identifier      String?   // User-defined label

  // Vial specs
  totalAmount     Float     // Total peptide amount in vial
  totalUnit       String    // 'mg', 'mcg', 'IU'

  // Reconstitution info
  diluentVolume   Float?    // ml of BAC water added
  concentration   Float?    // calculated: amount per ml
  concentrationUnit String? // e.g., 'mg/ml'

  dateReceived    DateTime?
  dateReconstituted DateTime?
  expirationDate  DateTime?

  // Usage tracking (peptides)
  remainingAmount Float?
  isExpired       Boolean   @default(false)
  isExhausted     Boolean   @default(false) // All doses used

  // Count tracking (supplements)
  itemCount       Int?      // Total items (e.g., 60 capsules)
  remainingCount  Int?      // Remaining items

  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  peptide         Peptide     @relation(fields: [peptideId], references: [id])

  // Indexes for query performance
  @@index([userId])
  @@index([userId, isExhausted])
  @@index([expirationDate])
  @@index([userId, isExpired, isExhausted])
}

// ============================================
// RECONSTITUTION CALCULATOR SAVED ENTRIES
// ============================================
model Reconstitution {
  id            String   @id @default(cuid())
  userId        String
  peptideId     String

  // Input values
  vialAmount    Float    // Total peptide in vial
  vialUnit      String   // 'mg', 'mcg', 'IU'
  diluentVolume Float    // ml of diluent added

  // Calculated results
  concentration     Float    // Amount per ml
  concentrationUnit String   // e.g., 'mcg/ml'

  // Dose calculation
  targetDose    Float?   // Desired dose per injection
  targetUnit    String?  // Unit for target dose
  volumePerDose Float?   // ml to draw for target dose

  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  peptide       Peptide     @relation(fields: [peptideId], references: [id])

  // Indexes for query performance
  @@index([userId])
}

// ============================================
// PROTOCOL HISTORY (Audit trail)
// ============================================
model ProtocolHistory {
  id          String   @id @default(cuid())
  protocolId  String

  changeType  String   // 'created', 'updated', 'paused', 'resumed', 'completed'
  changeData  String   // JSON of what changed

  createdAt   DateTime @default(now())

  // Relations
  protocol    Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  // Indexes for query performance
  @@index([protocolId])
}

// ============================================
// GENERAL NOTES
// ============================================
model Note {
  id          String   @id @default(cuid())
  entityType  String   // 'protocol', 'inventory', 'dose', etc.
  entityId    String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([entityType, entityId])
}

// ============================================
// PUSH SUBSCRIPTIONS (Web Push)
// ============================================
model PushSubscription {
  id          String   @id @default(cuid())

  // Subscription data from browser
  endpoint    String   @unique
  p256dh      String   // Public key
  auth        String   // Auth secret

  // User association (optional - for user-specific notifications)
  userId      String?

  // Notification preferences
  enabled     Boolean  @default(true)
  morningTime String?  // e.g., "08:00"
  eveningTime String?  // e.g., "20:00"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// ============================================
// DEVICE TOKENS (Native iOS/Android Push)
// ============================================
model DeviceToken {
  id          String   @id @default(cuid())

  // Device token from APNs (iOS) or FCM (Android)
  token       String   @unique
  platform    String   // 'ios' | 'android'

  // User association
  userId      String?

  // Notification preferences
  enabled     Boolean  @default(true)
  morningTime String?  // e.g., "08:00"
  eveningTime String?  // e.g., "20:00"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// ============================================
// HEALTH INTEGRATIONS
// ============================================
model HealthIntegration {
  id            String   @id @default(cuid())
  userId        String
  provider      String   // 'apple_health' | 'oura' | 'whoop'

  // OAuth tokens (encrypted at rest by Turso)
  accessToken   String?
  refreshToken  String?
  tokenExpiry   DateTime?

  // Connection status
  isConnected   Boolean  @default(false)
  lastSyncAt    DateTime?
  syncError     String?

  // Preferences
  enabledMetrics String?  // JSON array: ["sleep", "hrv", "rhr"]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
}

// ============================================
// HEALTH METRICS
// ============================================
model HealthMetric {
  id          String   @id @default(cuid())
  userId      String
  provider    String   // 'apple_health' | 'oura' | 'whoop'

  metricType  String   // 'sleep_duration' | 'hrv' | 'rhr' | 'sleep_score' | 'weight' | 'steps'
  value       Float
  unit        String   // 'minutes' | 'ms' | 'bpm' | 'score' | 'kg' | 'steps'

  recordedAt  DateTime // When the metric was recorded
  context     String?  // JSON: { "sleep_stage": "deep", "source": "watch" }

  createdAt   DateTime @default(now())

  user        UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, metricType, recordedAt])
  @@index([userId, recordedAt])
  @@index([userId, metricType])
}

// ============================================
// HEALTH SYNC LOG
// ============================================
model HealthSyncLog {
  id          String   @id @default(cuid())
  userId      String
  provider    String

  status      String   // 'success' | 'partial' | 'failed'
  metricsCount Int     @default(0)
  errorMessage String?

  startedAt   DateTime
  completedAt DateTime?

  @@index([userId, provider])
}

// ============================================
// LAB RESULTS
// ============================================
model LabResult {
  id        String   @id @default(cuid())
  userId    String
  testDate  DateTime
  labName   String?  // "Quest Diagnostics", "LabCorp"
  notes     String?

  // Markers stored as JSON array for flexibility:
  // [{ "name": "Total Testosterone", "value": 850, "unit": "ng/dL",
  //    "rangeLow": 300, "rangeHigh": 1000, "flag": "normal" }]
  markers   String   @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, testDate])
}

// ============================================
// LAB UPLOADS (Structured â€” replaces JSON blob)
// ============================================
model LabUpload {
  id            String   @id @default(cuid())
  userId        String
  testDate      DateTime            // Date blood was drawn
  labName       String?             // "Function Health", "Quest Diagnostics"
  source        String   @default("manual")  // "pdf_import" | "manual" | "api"
  notes         String?
  rawText       String?             // Preserved PDF text for re-parsing
  confidence    Float?              // Overall parse confidence 0-1
  fileName      String?             // Original PDF filename

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  biomarkers    LabBiomarker[]
  review        LabEventReview?
  preDrawContext PreDrawContext?
  user          UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, testDate])
  @@index([userId])
}

// ============================================
// LAB EVENT REVIEW (Computed intelligence per upload)
// ============================================
model LabEventReview {
  id              String   @id @default(cuid())
  userId          String
  labUploadId     String   @unique
  labDate         DateTime

  // Computed on upload (persisted as JSON strings)
  domainSummaries String   @default("[]")
  markerDeltas    String   @default("[]")
  predictions     String   @default("[]")
  protocolScores  String   @default("[]")
  evidenceLedger  String   @default("[]")
  trialCyclePhase String   @default("plan")

  // Top-level verdict
  verdictHeadline    String   @default("")
  verdictTakeaways   String   @default("[]")
  verdictFocus       String   @default("")
  verdictConfidence  String   @default("low")

  computedAt      DateTime @default(now())
  updatedAt       DateTime @updatedAt

  labUpload       LabUpload @relation(fields: [labUploadId], references: [id], onDelete: Cascade)

  @@index([userId, labDate])
  @@index([userId])
}

// ============================================
// LAB BIOMARKERS (Individual parsed markers)
// ============================================
model LabBiomarker {
  id              String   @id @default(cuid())
  uploadId        String
  biomarkerKey    String              // Canonical key from registry: "total_testosterone"
  rawName         String?             // Original name from PDF: "Testosterone, Total"
  value           Float
  unit            String              // Canonical storage unit
  originalValue   Float?              // Pre-conversion value if unit converted
  originalUnit    String?             // Pre-conversion unit
  rangeLow        Float?              // Lab's reference range min
  rangeHigh       Float?              // Lab's reference range max
  flag            String              // "low" | "normal" | "optimal" | "high" | "critical_low" | "critical_high"
  confidence      Float?              // Parse confidence for this marker (0-1)
  category        String?             // From BiomarkerDefinition.category

  createdAt       DateTime @default(now())

  upload          LabUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@index([uploadId])
  @@index([biomarkerKey])
  @@unique([uploadId, biomarkerKey])
}

// ============================================
// PRE-DRAW CONTEXT (contextual factors at time of blood draw)
// ============================================
model PreDrawContext {
  id                 String    @id @default(cuid())
  labUploadId        String    @unique
  exercisedWithin24h Boolean   @default(false)
  fastingHours       Int?
  recentIllness      Boolean   @default(false)
  illnessType        String?
  drawTime           String?
  newSupplements     String?   // JSON array
  unusualStress      Boolean   @default(false)
  notes              String?
  createdAt          DateTime  @default(now())

  labUpload          LabUpload @relation(fields: [labUploadId], references: [id], onDelete: Cascade)
}

// ============================================
// BIOLOGICAL LITERACY (user engagement tier tracking)
// ============================================
model UserBiologicalLiteracy {
  id              String    @id @default(cuid())
  userId          String    @unique
  level           String    @default("explorer")  // explorer|student|practitioner|scientist
  selfSelected    Boolean   @default(false)
  detailTaps      Int       @default(0)
  labViewCount    Int       @default(0)
  insightViews    Int       @default(0)
  lastLevelChange DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// DISCOVERY INSIGHTS (daily curated feed items)
// ============================================
model DiscoveryInsight {
  id             String    @id @default(cuid())
  userId         String
  type           String    // pattern|cross_domain|milestone|predictive|surprise|retest|achievement|educational
  title          String
  body           String    // tier-adapted content
  domain         String?
  relatedMarkers String?   // JSON array of biomarker keys
  priority       Int       @default(5)
  seen           Boolean   @default(false)
  dismissed      Boolean   @default(false)
  generatedAt    DateTime  @default(now())
  expiresAt      DateTime?

  user           UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, generatedAt])
  @@index([userId, seen])
}

// ============================================
// HEALTH BRAIN SNAPSHOTS (Orchestrator output cache)
// ============================================
model HealthBrainSnapshot {
  id                   String   @id @default(cuid())
  userId               String
  triggerEvent         String   @default("manual_refresh") // lab_upload|daily_wearable_sync|protocol_change|manual_refresh
  evaluatedAt          DateTime @default(now())
  pipelineMs           Int?

  // Domain assessments (JSON strings)
  domainsJson          String   @default("{}")
  agingVelocityJson    String   @default("{}")
  allostasisJson       String   @default("{}")
  riskTrajectoriesJson String   @default("{}")
  protocolEvidenceJson String   @default("[]")
  predictionsJson      String   @default("[]")
  narrativesJson       String   @default("[]")
  actionItemsJson      String   @default("[]")

  // Unified outputs
  unifiedScore         Float?
  dailyStatusJson      String   @default("{}")
  confidenceJson       String   @default("{}")
  dataCompleteness     Float    @default(0)

  createdAt            DateTime @default(now())
  user                 UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, evaluatedAt])
}

// ============================================
// PERSONAL BASELINES (Bayesian biomarker baselines)
// ============================================
model PersonalBaseline {
  id                   String    @id @default(cuid())
  userId               String
  biomarkerKey         String
  personalMean         Float
  personalSD           Float
  drawCount            Int       @default(0)
  populationPercentile Float?
  trend                String    @default("stable") // improving|stable|declining
  trendConfidence      Float     @default(0)
  lastLabValue         Float?
  lastLabDate          DateTime?
  updatedAt            DateTime  @updatedAt
  createdAt            DateTime  @default(now())
  user                 UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, biomarkerKey])
}

// ============================================
// LAB PRIOR RESET EVENTS (What changed when labs arrived)
// ============================================
model LabPriorResetEvent {
  id                     String   @id @default(cuid())
  userId                 String
  labUploadId            String
  baselinesUpdated       Int      @default(0)
  hypothesesResolved     Int      @default(0)
  domainsReweighted      Int      @default(0)
  protocolsReassessed    Int      @default(0)
  wearableSignalsQuieted Int      @default(0)
  summaryNarrative       String?
  createdAt              DateTime @default(now())
  user                   UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([labUploadId])
}

// ============================================
// PROTOCOL LAB EXPECTATIONS (Expected biomarker changes per protocol)
// ============================================
model ProtocolLabExpectation {
  id                     String   @id @default(cuid())
  protocolId             String
  biomarkerKey           String
  expectedDirection      String   // "increase" | "decrease" | "stable"
  expectedMagnitudeRange String   // JSON: {"min": 5, "max": 20} (% change)
  onsetWeeks             String   // JSON: {"min": 4, "max": 8}
  peakWeeks              String   // JSON: {"min": 8, "max": 16}
  evidenceLevel          String   // "clinical_trials" | "preclinical" | "anecdotal" | "theoretical"
  mechanism              String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  protocol               Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  @@unique([protocolId, biomarkerKey])
  @@index([protocolId])
  @@index([biomarkerKey])
}

// ============================================
// WEEKLY HEALTH BRIEF (Cached weekly intelligence briefs)
// ============================================
model WeeklyHealthBrief {
  id              String   @id @default(cuid())
  userId          String
  weekStartDate   DateTime
  headline        String
  domainSummaries String   // JSON
  protocolUpdates String   // JSON
  actionItems     String   // JSON
  labStatus       String   // JSON
  lookAhead       String   // Plain text summary
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStartDate])
  @@index([userId, weekStartDate])
}

// ============================================
// WEARABLE-LAB CORRELATIONS (Personal cross-modal correlations)
// ============================================
model WearableLabCorrelation {
  id                     String   @id @default(cuid())
  userId                 String
  wearableMetricType     String
  biomarkerKey           String
  correlationCoefficient Float
  sampleSize             Int
  directionality         String   // "direct" | "inverse" | "none"
  lastUpdated            DateTime @default(now())
  createdAt              DateTime @default(now())

  user                   UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, wearableMetricType, biomarkerKey])
  @@index([userId])
  @@index([userId, wearableMetricType])
}
